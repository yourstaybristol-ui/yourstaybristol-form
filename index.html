<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Stay Bristol: Make a Payment</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Old+Standard+TT&family=Open+Sans&display=swap" rel="stylesheet">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png" />

  <style>
    body { font-family:'Open Sans',sans-serif; padding:20px; background:#fff; color:#333; }
    #logo { display:block; margin:0 auto 10px auto; width:220px; }
    h2 { font-family:'Old Standard TT',serif; color:#2c3e50; font-size:24px; text-align:center; margin:0 0 10px 0; }
    #intro,#note { text-align:center; font-size:14px; margin:20px auto; color:#555; max-width:600px; }
    form { width:430px; margin:0 auto; }
    .form-row { display:flex; align-items:center; gap:6px; margin-bottom:6px; }
    .form-row label { font-size:14px; width:170px; text-align:left; margin-right:10px; }
    .input-wrapper { flex-grow:1; }
    input { padding:6px; font-size:13px; font-weight:bold; box-sizing:border-box; width:100%; height:30px; }
    input[readonly] { background:#f0f0f0; color:#555; }
    #submit-container { display:flex; justify-content:center; margin-top:20px; }
    button { padding:8px 16px; font-size:14px; background:#6a1b9a; color:#fff; border:none; cursor:pointer; }
    button:hover { background:#4a148c; }
    #spinner-container { display:none; text-align:center; margin-top:40px; }
    .spinner { width:100px; height:100px; margin:20px auto; display:block; }
    @media(max-width:600px){ .spinner{width:60px;height:60px;} }
    #debug { margin-top:30px; font-size:13px; background:#f9f9f9; border:1px solid #ccc; padding:10px; border-radius:4px; }
    footer { margin-top:40px; text-align:center; font-size:13px; color:#555; }
    footer a { color:#6a1b9a; text-decoration:none; margin:0 8px; }
    footer a:hover { text-decoration:underline; }
  </style>
</head>

<body>

  <a href="https://www.yourstaybristol.co.uk/" target="_blank">
    <img src="logo.png" alt="Your Stay Bristol Logo" id="logo" />
  </a>

  <h2>Your Stay Bristol: Make a Payment</h2>
  <p id="intro">
    Your Stay Bristol request payment of the amount below for the booking identified by the guest name and reference.
  </p>

  <div id="form-wrapper">
    <form action="https://gateway.cardstream.com/hosted/" method="POST">	

      <!-- Payment Amount (visible, formatted) -->
      <div class="form-row">
        <label for="paymentAmount">Payment Amount:</label>
        <div class="input-wrapper">
          <input type="text" id="paymentAmount" readonly />
        </div>
      </div>

      <!-- Guest Name -->
      <div class="form-row">
        <label for="guestName">Guest Name:</label>
        <div class="input-wrapper">
          <input type="text" id="guestName" readonly />
        </div>
      </div>

      <!-- YSB Booking Ref -->
      <div class="form-row">
        <label for="bookingRef">YSB Booking Ref:</label>
        <div class="input-wrapper">
          <input type="text" id="bookingRef" readonly />
        </div>
      </div>

      <!-- Hidden Cardstream fields -->
      <input type="hidden" id="amountHidden" name="amount" value="">
      <input type="hidden" name="merchantID" value="283320">
      <input type="hidden" name="action" value="SALE">
      <input type="hidden" name="type" value="1">
      <input type="hidden" name="countryCode" value="826">
      <input type="hidden" name="currencyCode" value="826">
      <input type="hidden" id="orderRef" name="orderRef" value="">
      <input type="hidden" name="redirectURL" value="https://www.yourstaybristol.co.uk/payment-success">
      <input type="hidden" name="cancelURL" value="https://www.yourstaybristol.co.uk/payment-failed">

      <p id="note">
        Click 'Proceed' to continue to our payment solution partner, Cardstream, where you will be asked to enter your card details and make payment.
        <strong>Please ensure you enter the card billing address</strong> as without a match the transaction will fail.
      </p>

      <div id="submit-container">
        <button type="submit" id="proceed-btn">Proceed</button>
      </div>
    </form>

    <!-- Debug block -->
    <div id="debug">
  	<strong>Debug Info (Cardstream Payload):</strong><br>
  	<span><strong>Merchant ID:</strong> <span id="debug-merchantID"></span></span><br>
  	<span><strong>Action:</strong> <span id="debug-action"></span></span><br>
  	<span><strong>Type:</strong> <span id="debug-type"></span></span><br>
  	<span><strong>Country Code:</strong> <span id="debug-countryCode"></span></span><br>
  	<span><strong>Currency Code:</strong> <span id="debug-currencyCode"></span></span><br>
  	<span><strong>Amount:</strong> <span id="debug-amount"></span></span><br>
  	<span><strong>Order Ref:</strong> <span id="debug-orderRef"></span></span><br>
  	<span><strong>Transaction Unique:</strong> <span id="debug-transactionUnique"></span></span><br>
  	<span><strong>Redirect URL:</strong> <span id="debug-redirectURL"></span></span><br>
  	<span><strong>Cancel URL:</strong> <span id="debug-cancelURL"></span></span>
    </div>

  <!-- Spinner + redirect message -->
  <div id="spinner-container">
    <p style="font-size:16px;">Redirecting to our secure payment partner, Cardstream… please wait.</p>
    <p style="font-size:14px;">Loading...</p>
    <svg class="spinner" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <g transform="translate(50,50)">
        <g>
          <animateTransform attributeName="transform" type="rotate" from="0" to="360" dur="2.2s" repeatCount="indefinite"/>
          <g fill="#6a1b9a">
            <rect x="-4" y="-35" width="8" height="20" rx="4" ry="4" opacity="1"/>
            <rect x="-4" y="-35" width="8" height="20" rx="4" ry="4" transform="rotate(30)" opacity="0.9"/>
            <rect x="-4" y="-35" width="8" height="20" rx="4" ry="4" transform="rotate(60)" opacity="0.8"/>
            <rect x="-4" y="-35" width="8" height="20" rx="4" ry="4" transform="rotate(90)" opacity="0.7"/>
            <rect x="-4" y="-35" width="8" height="20" rx="4" ry="4" transform="rotate(120)" opacity="0.6"/>
            <rect x="-4" y="-35" width="8" height="20" rx="4" ry="4" transform="rotate(150)" opacity="0.5"/>
            <rect x="-4" y="-35" width="8" height="20" rx="4" ry="4" transform="rotate(180)" opacity="0.4"/>
            <rect x="-4" y="-35" width="8" height="20" rx="4" ry="4" transform="rotate(210)" opacity="0.3"/>
            <rect x="-4" y="-35" width="8" height="20" rx="4" ry="4" transform="rotate(240)" opacity="0.2"/>
            <rect x="-4" y="-35" width="8" height="20" rx="4" ry="4" transform="rotate(270)" opacity="0.1"/>
            <rect x="-4" y="-35" width="8" height="20" rx="4" ry="4" transform="rotate(300)" opacity="0.05"/>
            <rect x="-4" y="-35" width="8" height="20" rx="4" ry="4" transform="rotate(330)" opacity="0.02"/>
          </g>
        </g>
      </g>
    </svg>
  </div>

  <footer>
    <hr style="margin-bottom:10px;">
    <p>
      <a href="https://www.yourstaybristol.co.uk/about-us" target="_blank">About Us</a> |
      <a href="https://www.yourstaybristol.co.uk/locations" target="_blank">Locations</a> |
      <a href="https://www.yourstaybristol.co.uk/terms-and-conditions" target="_blank">Terms & Conditions</a> |
      <a href="https://www.yourstaybristol.co.uk/privacy-policy" target="_blank">Privacy Policy</a>
    </p>
    <p>© Your Stay Bristol Ltd</p>
  </footer>  

<script>
  // Parse query string
  const params = new URLSearchParams(window.location.search);

  // Field references
  const amountField = document.getElementById("paymentAmount");   // visible
  const amountHidden = document.getElementById("amountHidden");   // hidden for Cardstream
  const guestField = document.getElementById("guestName");
  const bookingField = document.getElementById("bookingRef");
  const orderRefField = document.getElementById("orderRef");
  const transactionUniqueField = document.getElementById("transactionUnique");

  // Format currency for display
  function formatCurrency(poundsStr) {
    const pounds = parseFloat(poundsStr).toFixed(2);
    return "£" + pounds.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  // Prefill fields from query string
  if (params.has("paymentAmount")) {
    const rawAmount = params.get("paymentAmount"); // e.g. "77250.99" (pounds)
    amountField.value = formatCurrency(rawAmount); // display £77,250.99
    const penceValue = Math.round(parseFloat(rawAmount) * 100);   // convert to pence
    amountHidden.value = penceValue;                              // send raw pence
  }

  if (params.has("guestName")) {
    guestField.value = params.get("guestName"); // display only, not sent
  }

  if (params.has("bookingRef")) {
    bookingField.value = params.get("bookingRef"); // display only
    orderRefField.value = params.get("bookingRef"); // send as orderRef
  }

  // Generate transactionUnique
  transactionUniqueField.value = Date.now().toString();

  // Conditional source field injection (display only)
  const source = params.get("source");
  const sourceRef = params.get("sourceRef");

  if (source || sourceRef) {
    const bookingRefRow = document.getElementById("bookingRef").closest(".form-row");

    const sourceRow = document.createElement("div");
    sourceRow.className = "form-row";

    const sourceLabel = document.createElement("label");
    sourceLabel.setAttribute("for", "sourceField");
    sourceLabel.textContent = source + " Ref:";

    const sourceWrapper = document.createElement("div");
    sourceWrapper.className = "input-wrapper";

    const sourceInput = document.createElement("input");
    sourceInput.type = "text";
    sourceInput.id = "sourceField";
    sourceInput.readOnly = true;
    sourceInput.value = sourceRef || source;

    sourceWrapper.appendChild(sourceInput);
    sourceRow.appendChild(sourceLabel);
    sourceRow.appendChild(sourceWrapper);

    bookingRefRow.insertAdjacentElement("afterend", sourceRow);
  }

  // Update debug block
  function updateDebug() {
    document.getElementById("debug-merchantID").textContent = document.querySelector('input[name="merchantID"]').value;
    document.getElementById("debug-action").textContent = document.querySelector('input[name="action"]').value;
    document.getElementById("debug-type").textContent = document.querySelector('input[name="type"]').value;
    document.getElementById("debug-countryCode").textContent = document.querySelector('input[name="countryCode"]').value;
    document.getElementById("debug-currencyCode").textContent = document.querySelector('input[name="currencyCode"]').value;
    document.getElementById("debug-amount").textContent = amountField.value + " (" + amountHidden.value + " pence)";
    document.getElementById("debug-orderRef").textContent = orderRefField.value;
    document.getElementById("debug-transactionUnique").textContent = transactionUniqueField.value;
    document.getElementById("debug-redirectURL").textContent = document.querySelector('input[name="redirectURL"]').value;
    document.getElementById("debug-cancelURL").textContent = document.querySelector('input[name="cancelURL"]').value;
  }

  // Call after all values are set
  updateDebug();

  // Spinner toggle
  document.getElementById("proceed-btn").addEventListener("click", function() {
    document.querySelector("form").style.display = "none";
    document.getElementById("spinner-container").style.display = "block";
    updateDebug();
    console.log("Proceed clicked. Spinner shown.");
  });
</script>
</body>
</html>