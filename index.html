<script>
  alert("Script is running âœ…");

  // Manual fallback parser
  function getParam(key) {
    const url = window.location.href;
    const regex = new RegExp('[?&]' + key + '=([^&#]*)', 'i');
    const match = regex.exec(url);
    return match ? decodeURIComponent(match[1].replace(/\+/g, ' ')) : '';
  }

  // Populate visible fields
  document.getElementById('paymentAmount').value = getParam('paymentAmount');
  document.getElementById('guestName').value = getParam('guestName');
  document.getElementById('bookingRef').value = getParam('bookingRef');

  // Convert amount to minor units
  const amountClean = getParam('paymentAmount').replace(/[^0-9.]/g, '');
  const amountMinor = Math.round(parseFloat(amountClean) * 100);
  document.getElementById('amountMinor').value = amountMinor;

  // Set hidden orderRef
  document.getElementById('orderRefHidden').value = getParam('bookingRef');

  // Populate debug block
  document.getElementById('debugMID').textContent = "283320";
  document.getElementById('debugAmount').textContent = amountMinor;
  document.getElementById('debugOrderRef').textContent = getParam('bookingRef');
  document.getElementById('debugRedirect').textContent = "https://www.yourstaybristol.co.uk/payment-success";
  document.getElementById('debugCallback').textContent = "https://www.yourstaybristol.co.uk/payment-failed";

  // Conditional source field
  if (getParam('source')) {
    const bookingRefRow = document.getElementById('bookingRef').closest('.form-row');
    const sourceRow = document.createElement('div');
    sourceRow.className = 'form-row';

    const sourceLabel = document.createElement('label');
    sourceLabel.textContent = getParam('source') + ' Ref:';

    const sourceWrapper = document.createElement('div');
    sourceWrapper.className = 'input-wrapper';

    const sourceInput = document.createElement('input');
    sourceInput.type = 'text';
    sourceInput.readOnly = true;
    sourceInput.value = getParam('sourceRef') || getParam('source');

    sourceWrapper.appendChild(sourceInput);
    sourceRow.appendChild(sourceLabel);
    sourceRow.appendChild(sourceWrapper);

    bookingRefRow.insertAdjacentElement('afterend', sourceRow);
  }

  // Proceed button handler
  document.getElementById('proceedButton').addEventListener('click', function () {
    document.querySelector('form').style.display = 'none';
    document.getElementById('loadingScreen').style.display = 'block';
    setTimeout(function () {
      document.querySelector('form').submit();
    }, 2000);
  });

  // Console logs for visibility
  console.log("Full URL:", window.location.href);
  console.log("Parsed paymentAmount:", getParam('paymentAmount'));
  console.log("Parsed guestName:", getParam('guestName'));
  console.log("Parsed bookingRef:", getParam('bookingRef'));
  console.log("Parsed source:", getParam('source'));
  console.log("Parsed sourceRef:", getParam('sourceRef'));
</script>